stages:
  - install
  - build-test

cache:
  paths:
    - fronts/node_modules/
    - backend/venv/

install-fronts-dependencies:
  image: node:latest
  stage: install
  script:
    - cd fronts
    - echo "Installing packages..."
    - npm install
  artifacts:
    paths:
      - fronts/node_modules/
  only:
    refs:
      - merge_requests
    changes:
      - fronts/*

install-backend-dependencies:
  image: python:3.8
  stage: install
  script:
    - cd backend
    - echo "Installing python env and requirements..."
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -e ./src
  only:
    refs:
      - merge_requests
    changes:
      - backend/*
  artifacts:
    paths:
      - backend/venv/

install-cisu-package-dependencies:
  image: python:3.8
  stage: install
  script:
    - cd schema
    - echo "Installing python env and requirements..."
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -r requirements.test.txt
    - pip install -e .
  artifacts:
    paths:
      - cisu/venv/
  only:
    refs:
      - merge_requests
    changes:
      - cisu/*


front-enki-build-and-test:
  image: node:latest
  stage: build-test
  script:
    - cd fronts
    - echo "Building enki front app..."
    # - npm run build enki
    # - echo "Testing enki front app..."
    # - npm test enki
  only:
    refs:
      - merge_requests
    changes:
      - fronts/*

front-couvops-build-and-test:
  image: node:latest
  stage: build-test
  script:
    - cd fronts
    - echo "Building couv-ops front app..."
    - npm run build couv-ops
    - echo "Testing core-couv-ops..."
    - npm test core-couv-ops
  only:
    refs:
      - merge_requests
    changes:
      - fronts/*

back-build-and-test:
  image: python:3.8
  stage: build-test
  script:
    - cd backend
    - source venv/bin/activate
    - echo "Unit testing..."
    - pytest tests/unit
    - echo "Integration testing..."
    - pytest tests/integration
    - echo "Flask e2e testing..."
    - pytest tests/e2e
  only:
    refs:
      - merge_requests
    changes:
      - backend/*

cisu-build-and-test:
  image: python:3.8
  stage: build-test
  script:
    - cd schema
    - source venv/bin/activate
    - echo "Unit testing..."
    - pytest tests/unit
  only:
    refs:
      - merge_requests
    changes:
      - cisu/*